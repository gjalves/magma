user root;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
  worker_connections 1024;
}

http {
  map $srv $srvport {
    default 9081;
{%- for service, value in service_registry.items() %}
  {%- if value['proxy_type'] == 'clientcert' %}
    {{ service }} {{ value.port }};
  {%- endif %}
  {%- if 'proxy_aliases' in value -%}
  {%- for alias, map in value['proxy_aliases'].items() %}
    {{ alias }} {{ map.port }};
  {%- endfor -%}
  {%- endif -%}
{%- endfor %}
  }

  map $srv $open_srvport {
    default 9070;
{%- for service, value in service_registry.items() %}
  {%- if value['proxy_type'] == 'open' %}
    {{ service }} {{ value.port }};
  {%- endif %}
{%- endfor %}
  }

  map $ssl_client_s_dn $ssl_client_s_dn_cn {
    default "";
    ~/CN=(?<CN>[^/]+) $CN;
  }

  server {
    listen              8443 ssl http2;
    server_name         ~^(?<srv>.+)-{{ controller_hostname }}$;
    root                /var/www;

    error_log  /var/log/nginx/error.log info;
    access_log /var/log/nginx/access.log;

    ssl_certificate     /var/opt/magma/certs/controller.crt;
    ssl_certificate_key /var/opt/magma/certs/controller.key;
    ssl_verify_client on;
    ssl_client_certificate /var/opt/magma/certs/certifier.pem;

    location / {
      {%- if resolver %}
      resolver {{ resolver }};
      {%- endif %}
      grpc_pass grpc://{{ backend }}:$srvport;

      grpc_set_header x-magma-client-cert-cn $ssl_client_s_dn_cn;
      grpc_set_header x-magma-client-cert-serial $ssl_client_serial;
    }
  }

  server {
    listen 8444 ssl http2;
    server_name         ~^(?<srv>.+)-{{ controller_hostname }}$;
    root                /var/www;

    error_log  /var/log/nginx/error.log info;
    access_log /var/log/nginx/access.log;

    ssl_certificate     /var/opt/magma/certs/controller.crt;
    ssl_certificate_key /var/opt/magma/certs/controller.key;

    location / {
      {%- if resolver %}
      resolver {{ resolver }};
      {%- endif %}

      grpc_pass grpc://{{ backend }}:$open_srvport;
    }
  }
}
